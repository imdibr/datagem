name: Basic checks

on:
  push:
    branches: [ main, master, 'feature/*' ]
  pull_request:
    branches: [ main, master ]

jobs:
  basic:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show repo info
        run: |
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Event: $GITHUB_EVENT_NAME"
          echo "Ref: $GITHUB_REF"
          echo "Commit: $GITHUB_SHA"
          echo "Changed files (last commit):"
          git --no-pager show --name-only --pretty="" "$GITHUB_SHA" || true

  backend-lint-and-test:
    runs-on: ubuntu-latest
    needs: basic
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Check for backend changes
        id: changes
        run: |
          echo "CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})" >> $GITHUB_ENV
          echo "CHANGED_BACKEND=$(echo $CHANGED_FILES | grep -E '^(datagem_backend/|requirements.txt)')" >> $GITHUB_ENV
      - name: Run backend jobs if backend changes
        if: env.CHANGED_BACKEND
        run: |
          echo "Running backend lint and tests"
      - name: Set up Python
        if: env.CHANGED_BACKEND
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        if: env.CHANGED_BACKEND
        run: |
          python -m pip install --upgrade pip
          if [ -f datagem_backend/requirements.txt ]; then pip install -r datagem_backend/requirements.txt; fi
      - name: Run backend linters (flake8) if available
        if: env.CHANGED_BACKEND
        run: |
          if command -v flake8 >/dev/null 2>&1; then
            flake8 || true
          else
            echo "flake8 not installed or requirements do not include it"
          fi
      - name: Run backend tests (pytest) if available
        if: env.CHANGED_BACKEND
        run: |
          if command -v pytest >/dev/null 2>&1; then
            pytest || true
          else
            echo "pytest not available"
          fi

  frontend-lint-and-test:
    runs-on: ubuntu-latest
    needs: basic
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Check for frontend changes
        id: changes
        run: |
          echo "CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})" >> $GITHUB_ENV
          echo "CHANGED_FRONTEND=$(echo $CHANGED_FILES | grep -E '^(datagem_frontend/|package.json)')" >> $GITHUB_ENV
      - name: Run frontend jobs if frontend changes
        if: env.CHANGED_FRONTEND
        run: |
          echo "Running frontend lint and tests"
      - name: Use Node.js
        if: env.CHANGED_FRONTEND
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        if: env.CHANGED_FRONTEND
        run: |
          cd datagem_frontend
          if [ -f package-lock.json ]; then npm ci; else npm install; fi
      - name: Run frontend lint (eslint) if available
        if: env.CHANGED_FRONTEND
        run: |
          if command -v npx >/dev/null 2>&1; then
            npx eslint . || true
          else
            echo "eslint not installed"
          fi
      - name: Run frontend build (optional)
        if: env.CHANGED_FRONTEND
        run: |
          if [ -f package.json ] && grep -q "\"build\":" package.json; then
            npm run build || true
          else
            echo "No build script defined"
          fi
