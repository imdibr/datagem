name: n8n + MCP Integration

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REPO_NAME: datagem
  FRONTEND_DIR: datagem_frontend
  BACKEND_DIR: datagem_backend

jobs:
  test-frontend:
    name: Frontend - install & build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install frontend deps
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm ci

      - name: Build frontend
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm run build

  test-backend:
    name: Backend - install & lint
    runs-on: ubuntu-latest
    needs: test-frontend
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install backend requirements
        working-directory: ${{ env.BACKEND_DIR }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: (Optional) Run backend tests
        working-directory: ${{ env.BACKEND_DIR }}
        run: |
          # add test command if available, e.g. pytest
          echo "No tests configured" 

  n8n-trigger:
    name: Trigger n8n workflow
    runs-on: ubuntu-latest
    needs: test-backend
    outputs:
      n8n_status: ${{ steps.post_n8n.outputs.status_code }}
      n8n_response: ${{ steps.post_n8n.outputs.body }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare payload
        id: payload
        run: |
          echo "payload<<EOF" >> $GITHUB_OUTPUT
          echo "{\"repo\":\"${{ github.repository }}\",\"commit\":\"${{ github.sha }}\",\"ref\":\"${{ github.ref }}\",\"actor\":\"${{ github.actor }}\"}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Trigger n8n webhook
        id: post_n8n
        env:
          N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
        run: |
          body=$(jq -n --argjson payload "$payload" '$payload' 2>/dev/null || echo '{"repo":"'"${{ github.repository }}"'","commit":"'"${{ github.sha }}"'","ref":"'"${{ github.ref }}"'","actor":"'"${{ github.actor }}"'"}')
          # POST and capture status and response
          resp=$(curl -s -w "\n%{http_code}" -X POST "$N8N_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$body")
          # separate body and status
          status=$(echo "$resp" | tail -n1)
          body=$(echo "$resp" | sed '$d')
          echo "::set-output name=status_code::$status"
          echo "::set-output name=body::$body"

  mcp-connect:
    name: Connect to MCP server (conditional)
    runs-on: ubuntu-latest
    needs: n8n-trigger
    if: needs.n8n-trigger.outputs.n8n_status == '200' || needs.n8n-trigger.outputs.n8n_status == '201'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Call MCP server
        env:
          MCP_SERVER_URL: ${{ secrets.MCP_SERVER_URL }}
          MCP_API_KEY: ${{ secrets.MCP_API_KEY }}
          N8N_RESPONSE: ${{ needs.n8n-trigger.outputs.n8n_response }}
        run: |
          payload=$(jq -n \
            --arg repo "${{ github.repository }}" \
            --arg commit "${{ github.sha }}" \
            --arg ref "${{ github.ref }}" \
            --arg n8n "$N8N_RESPONSE" \
            '{"repo":$repo,"commit":$commit,"ref":$ref,"n8n_response":$n8n}')
          curl -sS -X POST "$MCP_SERVER_URL/connect" \
            -H "Authorization: Bearer $MCP_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$payload" -o /dev/null -w "status:%{http_code}\n"
